# Pico FM Synthesizer Sound Making

![Block Diagram](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/00_splush.jpg)  

　Pico FM Synthesizer (PiFM+S)での音色の作り方を見てみましょう。  

## 1. FM波形合成
　PiFM+SはFM変調で波形を合成するところから始まります。YAMAHAのDXシリーズなどで有名なFMサウンドと同じような音作りをします。最初は音色の骨格となる「素材」と「アルゴリズム」を選びます。アルゴリズムはオペレーターのつながり方です。  

### 1-1. 素材：オペレーターと波形
　シンセサイザーでは音を波打つ電気信号で作ります。波打つ電気信号を作り出す基本モジュールは発信器です。多くのFMサウンドの楽器と同様に、PiFM+Sでも発信器をオペレーターと呼ぶことにします。
　PiFM+Sには4個のオペレーターが入っています。オペレーターが発信する波形には大きく分けて基本波形とサンプリング波形があります。基本波形は数学的に作り出された波形で6種類あり、Noise以外は見るからにシンプルな形をしています。  
　サンプリング波形はPiFM+Sが持っているサンプリング機能を使って録音した音の一部を切り出して作り出す波形です。サンプリング波形は単純な数式では計算できないような波形にもなります。サンプリング波形はいくつでも用意できます。  
　
|基本波形|PiFM+Sの波形表示例|
|---|---|
|サイン波|![Sine](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_sine.jpg)|
|鋸歯状波|![Saw](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_saw.jpg)|
|三角波|![Triangle](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_tri.jpg)|
|矩形波|![Square](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_sqr.jpg)|
|サイン波の絶対値|![ABS Sine](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_waveabssine.jpg)|
|サイン波のプラス側|![Plus Sine](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_plussine.jpg)|
|ノイズ|![Noise](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_noise.jpg)|  


　「ぼぉーーー」っと声を出したサンプリング波形はこんな感じになりました。　　
　
|サンプリング波形の表示例|
|---|
|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_sample.jpg)|  


　サイン波は丸い音、鋸歯状波は文字通りギザギザした音を出します。作りたい音色をイメージしてオペレーターに波形を設定しましょう。Noiseは音程を持たないので、楽器には使いにくいですが、効果音などに使えます。    
　オペレーターの波形はWAVE欄で設定します。  

![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_00.jpg)  

　
### 1-2. 骨格：アルゴリズム
　1つのオペレーターは基本波形やサンプリング波形しか音を出せません。これでは作れる音色は限られてしまいます。そこで登場するのがアルゴリズムです。オペレーターを並べたり、積み上げたりして様々な音色を作り出します。  
　オペレーターを並べるアルゴリズムは比較的想像しやすい音色を作り出せます。2つのオペレーターを並べて音を出せば、2つの音色が混ざった音が聞こえます。オペレーター1と2と並べたアルゴリズムはこんな絵になります。  

`1---`  
`　　|`  
`　　+-->出力`  
`　　|`  
`2---`  
　  
　ここでは2つのオペレーターを積み重ねるアルゴリズムを使ってみましょう。アルゴリズムの絵はこんな感じです。

`1-->2-->出力`
　
　オペレーター1の波形がオペレーター2に入っています。ここで起こるのがFM変調です（FM=Frequency Modulationなので「変調」が重なってますが……） オペレーター1の出力の大きさや波形、波の数によって、オペレーター2に設定した波形がいろいろと変化します。 
　数式を見ても何がどうなるのか分かりにくいので、PiFM+Sで実例をみてみましょう。PiFM+SではFM変調後の波形を画面で確認できます。  
　オペレーターの出力の大きさはLEVLという欄で指定します。0〜255で、大きほど大きな出力になります。0は全く何も出力しません。
　最終的な出力となるオペレーターのLEVLはある程度大きくしないとスピーカーから音が出ません。出力につながったオペレーター群のLEVLの合計が255になるように調整すると良いです。    

|オペレーター設定|出力波形|やっていること|波形の変化|
|---|---|---|---|
|![LEVL=10](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_00.jpg)|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_01.jpg)|サイン波のオペレータ1の出力を小さくしています。|オペレーター2の波形は三角波ですが、あまり変わっていません。|
|![LEVL=85](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_10.jpg)|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_11.jpg)|オペレーター1の出力を少し大きくしてみました。|三角波が少しだけ歪みました。|
|![LEVL=120](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_20.jpg)|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_21.jpg)|オペレーター1の出力を中位いにしてみました。|三角波がさらに歪みました。|  

　オペレーターの波の数はFREQという欄で設定します。FREQが1のときはオペレーターに設定された波形がそのまま出力されます。2にすると波形が2回出力されます。  

|オペレーター設定|出力波形|やっていること|波形の変化|
|---|---|---|---|
|![FREQ=3](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_30.jpg)|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_31.jpg)|オペレーター1の波の数を3に増やしてみました。|三角波がまた違った形に変化しました。|
|![FREQ=5](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_40.jpg)|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_41.jpg)|オペレーター1の波の数を5にしてみました。|三角波が大きく変化しました。もはや三角波だったかもわかりません。|  

　FREQの下にあるDETUも波の数を変える設定です。FREQは整数倍で波の数を変えますが、DETUは小数点以下の値になって「1.3個分の波の数」といった指定ができます。1.3はFREQ=1, DETU=30です。  

　もう一つ、波形を変化させる手段としてフィードバックという設定があります。FDBK欄で設定します。  
　フィードバックはオペレーターの出力で自分自身のオペレーターを変調する機能です。FMサウンド特有の金属的な音が出たりしますが、フィードバックが大きすぎると音が歪んでしまって楽器には適さなくもなります。  

|オペレーター設定|出力波形|やっていること|波形の変化|
|---|---|---|---|
|![FDBK=2](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_50.jpg)|![Samplling](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_fm_51.jpg)|オペレーター1のフィードバックを2に設定。|ずいぶんとグニャグニャした波形になりました。|  

　アルゴリズムの種類（8個あります）によってフィードバック機能を使えるオペレーターは決まっています。フィードバック機能が有効なオペレーターの数字は<>で囲って表します。この例だとこんな感じです。  

`<1>-->2-->出力`

　このように、2つのオペレーターだけでも設定次第で複雑な波形を作ることができます。単なるサイン波と三角波からでも様々に波形が変化しました。オペレーターにサンプリング波形を使うと、さらに面白い波形を作ることができるかもしれません。  
　
　
### 1-3. 11種類のアルゴリズム
　PiFM+Sには11種類のアルゴリズムがあります。音色の骨格が11種類用意されているわけです。音色を並べたいのか、重ねたいのか、重ねたもの同士を並べたいのかなど考えてアルゴリズムを選択します。  
　ときにはパラメーター設定はそのままでアルゴリズムだけを切り替えると、思わぬ良い音色が出ることもあります。  

|アルゴリズム|構造|ALGOの表示|
|---|---|---|
|0|`<1>-->2-->`|`<1>*2`|
|1|`<1>--`<br/>`　　　+-->`<br/>`2----`|`<1>+2`|
|2|`<1>--`<br/>`　　　+`<br/>`2----`<br/>`　　　+-->`<br/>`<3>--`<br/>`　　　+`<br/>`4----`|`<1>+2+<3>+4`|
|3|`<1>-------`<br/>`　　　　　　+-->4`<br/>`<2>-->3---`|`(<1>+2*3)*4`|
|4|`<1>-->2-->3-->4`|`<1>*2*3*4`|
|5|`<1>-->2---`<br/>`　　　　　　+-->`<br/>`<3>-->4---`|`<1>*2+<3>*4`|
|6|`<1>----------`<br/>`　　　　　　　　+-->`<br/>`<2>-->3-->4--`|`<1>+<2>*3*4`|
|7|`<1>------`<br/>`　　　　　+`<br/>`<2>-->3--+-->`<br/>`　　　　　+`<br/>`<4>------`|`<1>+2*3+<4>`|
|8|`　　　-->2--`<br/>`<1>-\|　　　 \|`<br/>`　　　-->3--+-->`<br/>`　　　　　　 \|`<br/>`<4>--------`|<1>\*(2+3)+<4>|
|9|`　　　-->2-->3--`<br/>`<1>-\|　　　　　　+-->`<br/>`　　　-->4------`|<1>\*(2\*3+4)|
|10|`　　　 -->2---`<br/>`　　　\|　　　　\|`<br/>`<1>--+-->3---+-->`<br/>`　　　\|　　　　\|`<br/>`　　　 -->4---`|<1>\*(2+3+4)|

　アルゴリズムはSOUND MAIN画面のALGO欄で設定します。  
　
![Algorithm](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/01_sound_main.jpg)

### 1-4. シェイプ
　素材と骨格だけでも音色として使える波形ができますが、オプション機能として波形の形を全体的に変形する機能があります。波形合成用エンベロープによる変形です。波形合成用エンベロープは以下のような形の、これも波形です。  

![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_osc_adsr.png)  

　0.0〜1.0の間で時間的に変化します。StLvから始まって、ATCK単位時間をかけて1.0まで増加し、その後DECY単位時間をかけてSuLvまで下降し、さらにSuRs単位時間をかけてEdLvまで推移します。  
　波形合成用エンベロープがない（全域で1.0）場合に矩形波である波形と、そこに波形合成用エンベロープを設定した結果の波形を比較すると以下のようになります。  

|エンベロープ|波形|
|---|---|
|![Envelope](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_osc_00.jpg)|![Envelope](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_osc_01.jpg)|
|![Envelope](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_osc_10.jpg)|![Envelope](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_osc_11.jpg)|  

　適用したエンベロープと元の矩形波を図にすると以下の通りです。エンベロープが0に近づくと波形も0に近づきます。  
![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_osc_02.jpg)  

　たとえば、波形の後半にノイズがのっている場合に後半のエンベロープを0.0に近づけると、その部分の波形を消すことができます。  

### 1-5. 波形の再利用
　FM変調で作った波形はWAVE SHAPE画面で確認できます。ギザギザが激しい波形はノイズに近くなって楽器としては使いにくいといった傾向がわかります。  
　WAVE SHAPE画面では表示されている波形をサンプリング波形のデータとして保存することができます。  

![Algorithm](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/07_waveshape.jpg)  
　
　すると、その波形データをオペレーターの発信波形として使うことができるようになります。4個のオペレーターとアルゴリズムを駆使して作った波形を、たった1個のオペレーターで発信できるようになるわけです。	

![Algorithm](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_reuse.jpg)  

　このようにして、4個のオペレーターだけでは作れなかった波形もさらに変調をかけて作り出すことができます。マイクでサンプリングした波形も含めると、PiFM+Sは無限の波形を元にしてFM変調の音色を作り出すことができます。  

![Algorithm](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_wave_reuse_diagram.jpg)  

## 2. 加算波形合成
　PiFM+Sの波形合成には、FM合成のほかに加算波形合成があります。  

### 2-1. 加算波形合成の仕組み
　加算波形合成では最大8個のサイン波をシンプルに加算して波形を合成します。数学や物理学の世界では、どのような音色の波形でもいくつもの周波数と大きさを持つサイン波の足し算で作り出すことができることがわかっています。  
　楽器の音色を構成する周波数特性がわかっている場合、それらの周波数のサイン波を合成することで似た音色を作り出せます。精度を上げるには多数のサイン波が必要になりますが、PiFM+Sでは最大8個のサイン波を加算できます。なお、FM波形合成のアルゴリズム2は4個のオペレーターの加算合成になっているので、これと組み合わせると最大12個のサイン波を加算合成できます。  

### 2-2. サイン波の加算設定
　以下の画面で8個のサイン波を設定します。赤枠の3つのパラメーターが1つのサイン波に相当します。このグループが縦に2個、横に4個の合計8個並んでいます。  

![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/16_addwave.jpg) 　

#### 2-2-1. FREQ (RT2/RT5)  

	発信の1周期内に含めるサイン波の数（整数倍）を設定します。  

#### 2-2-2. DETU (RT3/RT6)  

	発信の1周期内に含めるサイン波の数（小数部.00〜.99）を設定します。    

#### 2-2-3. LEVL (RT4/RT7)  

	サイン波の出力振幅レベルを設定します。数値が大きいほど大きな出力となります。オーディオ出力用のオペレーター群の合計は255以下にする必要があります。  

### 2-3. クラリネットの音色
　以下の設定はクラリネットの音色を加算合成だけで作ったものです。

|周波数|サイン波の大きさ|周波数特性|
|---|---|---|
|基本周波数(1)|100|■■■■■■■■■■■■■■■■■■■■|
|2倍音|5|■|
|3倍音|60|■■■■■■■■■■■■|
|4倍音|10|■■|
|5倍音|60|■■■■■■■■■■■■|
|6倍音|20|■■■■|  

![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/16_addwave.jpg) 　

　合成された波形は以下のようになりました。  

![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/17_clarinet.jpg) 　

## 3. 特徴を際立たせる
　FM変調でできた波形でも十分に楽器の音色として使えるものができます。その音色にさらに特徴づけをするのがフィルターの機能です。耳障りな高音を消してマイルドな音色にしたり、低音を少なくしてきらびやかな音色に変えたりできます。  
　フィルターの種類と、その特徴を見てみましょう。  
　
### 3-1. フィルターの種類
|フィルター|読み方|動作|
|---|---|---|
|PASS|パス|FM変調の音色をそのまま通過させます。|
|LFP|ローパス|FM変調の音色の高音側を少なくします。|
|HPF|ハイパス|FM変調の音色の低音側を少なくします。|
|BPF|バンドパス|FM変調の音色のある高さの音以外を少なくします。|
|NOTCH|ノッチ|FM変調の音色のある高さの音を少なくします。|

### 3-2. PASS
　FM変調でできた音色をそのまま使う場合はPASSを選びます。特に設定はありません。  

### 3-3. LPF
　カットオフ周波数FREQというものを指定して、その周波数より高い音を少なくします。一般的に音色がマイルドになります。  
　レゾナンスまたはQファクターという値RESOは、指定した周波数部分を際立たせる働きを持ちます。値を大きくすると、一般的にはギュイーンというようなギラギラした音色が出ます。  

### 3-4. HPF
　カットオフ周波数FREQというものを指定して、その周波数より低い音を少なくします。一般的に音色がシャリシャリになります。  
　レゾナンスまたはQファクターという値RESOは、指定した周波数部分を際立たせる働きを持ちます。値を大きくすると、一般的にはギュイーンというようなギラギラした音色が出ます。  

### 3-5. BPF
　カットオフ周波数FREQというものを指定して、その周波数から離れた音を少なくします。  
　レゾナンスまたはQファクターという値RESOは、指定した周波数部分を際立たせる働きを持ちます。値を大きくすると、一般的にはギュイーンというようなギラギラした音色が出ます。  

### 3-6. NOTCH
　カットオフ周波数FREQというものを指定して、その周波数の周辺の音を少なくします。  
　レゾナンスまたはQファクターという値RESOは、指定した周波数部分を際立たせる働きを持ちます。値を大きくすると、一般的にはギュイーンというようなギラギラした音色が出ます。  


## 4. 特徴を変化させる
　フィルターでFM変調で作られた音色に特徴を際立たせることで、さらに音色作成のバリエーションが広がりました。このフィルターは音の出だしから消えるまでの間、ずっと同じ特徴しか持ちません。一方、実際の楽器は音の出だしから消えるまでの間に音色が変化して行きます。つまり、時間経過とともに音色が変わっています。  
　PiFM+Sのフィルターには時間経過に応じた変化を与えることができます。音色にフワフワした変化が付きます。  
　
### 4-1. フィルターモジュレーション
　短い周期でで音色が変化する効果を生み出すのがフィルターモジュレーションです。LFO（Low Frequency Oscillator：低周波発信器）という発信器が一定の波を作り出し、その波の速さと大きさでフィルターのカットオフ周波数を変動させます。  

#### 4-1-1. MODU  

	フィルターモジュレーションのON/OFFを設定します。  

#### 4-1-2. LFOr  

	フィルターモジュレーション用LFOの速さを設定します。  

#### 4-1-3. LFOf  

	フィルターモジュレーション用LFOの深さを設定します。  
　
### 4-2. フィルターエンベロープ
　時間経過とともに滑らかに音色に変化を付けるのがフィルターエンベロープです。エンベロープという波形の形状に従ってフィルターのカットオフ周波数やレゾナンスを変化させられます。音の出だしでは高い音が含まれるものの、時間とともにそれがなくなって行くといった変化を付けることができます。  
　設定するパラメータがたくさんありますが、実際の楽器らしい音を出すには重要な設定です。  
　フィルターエンベロープは以下のパラメータと形状を持っています。  
![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_flt_adsr.png)  

#### 4-2-1. INTV (RT2)  

	フィルターエンベロープの時間推移の間隔を指定します。通常の楽器では10〜50程度です。  
	
#### 4-2-2. FQmx (RT3)  

	フィルターのカットオフ周波数の最大変動幅（周波数）を設定します。  

#### 4-2-3. FQrv (RT3)  

	フィルターのカットオフ周波数の変動幅を反転（減少）させるか否かの設定をします。OFFで増加、ONで減少します。  
	
#### 3-2-4. Qfmx (RT3)  

	フィルターのQファクター値の最大変動幅を設定します。  

#### 4-2-5. Qfrv (RT3)  

	フィルターのQファクター値の変動幅を反転（減少）させるか否かの設定をします。OFFで増加、ONで減少します。  
　
#### 4-2-6. StLv (RT2)  

	エンベロープの最初のレベル（スタートレベル）を0.0〜1.0で設定します。
	レベル1.0でFQMxと同じ変動となり、レベルを0.0にするとフィルタの設定値のままとなります。  
	
#### 4-2-7. ATCK (RT3)  

	スタートレベルから1.0にまでスイープする長さをINTVの倍数で設定します。0は即座に移行することを表します。  

#### 4-2-8. DECY (RT4)  

	アタック完了後にサスティーンレベルまでスイープする長さをINTVの倍数で設定します。0は即座に移行することを表します。  

#### 4-2-9. SuLv (RT5)  

	ディケイが完了するレベル（サスティーンレベル）を0.0〜1.0で設定します。  

#### 4-2-10. SuRs (RT6)  

	サスティーンレベルからエンドレベルにスイープする長さをINTVの倍数で設定します。0は即座に移行することを表します。  

#### 4-2-11. EdLv (RT7)  

	最終的なレベルを0.0〜1.0で設定します。  


## 5. 音量を変化させる
　多くの楽器は音の出だしから消えるまで、その音量も時間経過で変化します。ピアノは鍵盤を押した瞬間に音が出ますが、バイオリンのような弦楽器は徐々に音が大きくなって一定の大きさになってから小さくなって消えて行くといった感じです。この変化を設定するのがVCAという機能で、これまでにも出てきたエンベロープという波形を使って音量を変化させます。  
　さらに、VCOというそもそもの音を出す機能にもトレモロやビブラートという言葉で知られる効果を付ける設定があります。
　VCAエンベロープは以下のパラメータと形状を持っています。  
![SOUND MAIN](https://github.com/ohira-s/PicoFM_Synth/blob/main/Doc/images/mkg_vca_adsr.png)  

### 5-1. VCAエンベロープ

#### 5-1-1. ATCK (RT2)  

	エンベロープのアタック秒数を設定します。  
	
#### 5-1-2. DECY (RT3)  

	エンベロープのディケイ秒数を設定します。  
	
#### 5-1-3. SuLv (RT4)  

	エンベロープのサスティーンレベルを0.0〜1.0で設定します。  

#### 5-1-4. RELS (RT5)  

	エンベロープのリリース秒数を設定します。  

#### 5-1-5. KEYS (RT6)  

キー・スケール・センシティビティーは音程に従って音量を変化させます。値は-9から+9です。  
0ではキーキー・スケール・センシティビティーは無効で、全音程でADSRとベロシティーの値に従います。  
正の値にすると、音程が高くなるにつれてアタックとサステインのレベルが両方とも大きくなります。  
負の値にすると、音程が高くなるにつれてアタックとサステインのレベルが両方とも小さくなります。  

### 5-2. トレモロ

#### 5-2-1. TREM (RT1)  

	トレモロのON/OFFを設定します。  
	
#### 5-2-2. TrRT (RT2)  

	トレモロの速さを設定します。  
	
#### 5-2-3. TrSC (RT3)  

	トレモロの深さを設定します。  


### 5-3. ビブラート

#### 5-3-1. VIBR (RT4)  

	ビブラートのON/OFFを設定します。  

#### 5-3-2. ViRT (RT5)  

	ビブラートの速さを設定します。  

#### 5-3-3. ViSC (RT6)  

	ビブラートの深さを設定します。  
